{% extends "base.html" %}
{% block title %}VØtre spectacle - AnimatoSpectacle{% endblock %}
{% block content %}
<h2>VØtre spectacle</h2>
<form method="post" enctype="multipart/form-data" class="form">
  <label>Raison sociale <span style="font-size:0.85rem;font-weight:normal;color:var(--muted);">(automatique, non modifiable)</span>
    <input type="text" name="raison_sociale" value="{{ user.username if user else '' }}" readonly style="background-color: #1a1a1f; cursor: not-allowed; opacity: 0.6;">
  </label>

  <label>Titre
    <input type="text" name="title" required>
  </label>

  <label>Description (max 200 mots)
    <textarea id="description" name="description" rows="4" required></textarea>
    <div id="desc-counter" style="font-size:.9rem;opacity:.8;margin-top:4px;">0/200 mots</div>
  </label>

  <div class="grid-2">
    <label>Région
      <input type="text" name="region" placeholder="Ex: Île-de-France, Bretagne...">
    </label>
    <label>Lieu
      <input type="text" name="location" placeholder="Ville / Salle">
    </label>
   </div>


  <label>Catégorie
    <input type="text" name="category" placeholder="Magie, Théâtre, Clown…">
  </label>

  <label>Catégorie 2
    <select name="categorie2" required>
      <option value="">-- Choisir --</option>
      <option value="adulte">Adulte</option>
      <option value="enfant">Enfant</option>
    </select>
  </label>

  <label>Âge
  <input type="text" name="age_range"
       value="{{ (request.form.get('age_range') if request.method=='POST' else (show.age_range if show else '')) or '' }}"
       placeholder="Tranche d'âge">
  </label> 

  <label>VØtre e-mail <span style="font-size:0.85rem;font-weight:normal;color:var(--muted);">(Pour mettre vØtre adresse courriel <a href="{{ url_for('legal') }}" style="color:var(--primary);text-decoration:underline;">nous contacter</a>)</span>
    <input type="email" name="contact_email" value="audition_2020@yahoo.fr" readonly style="background-color: #1a1a1f; cursor: not-allowed; opacity: 0.6;">
  </label>

  <label>VØtre téléphone <span style="font-size:0.85rem;font-weight:normal;color:var(--muted);">(visible uniquement par l'administrateur)</span>
    <input type="tel" name="contact_phone" placeholder="06 12 34 56 78" required>
  </label>

  <label>Image ou PDF <span style="font-size:0.85rem;font-weight:normal;color:var(--muted);">(Taille max : 5 MB)</span>
    <input type="file" name="file" accept=".png,.jpg,.jpeg,.gif,.webp,.pdf">
  </label>

  <div class="actions">
    <button type="submit">Envoyer</button>
    <a class="btn-secondary" href="{{ url_for('home') }}">Annuler</a>
  </div>
</form>
<p class="hint">VØtre annonce sera visible après validation par l’administrateur.</p>

<!-- Limiteur 200 mots (front) -->
<script>
(function () {
  const ta = document.getElementById('description');
  const counter = document.getElementById('desc-counter');
  const MAX = 200;

  if (!ta || !counter) return;

  function update() {
    const words = ta.value.trim().split(/\s+/).filter(Boolean);
    if (words.length > MAX) {
      // tronque au-delà de 200 mots
      ta.value = words.slice(0, MAX).join(' ');
    }
    const count = ta.value.trim() ? ta.value.trim().split(/\s+/).length : 0;
    counter.textContent = `${count}/${MAX} mots`;
  }

  ta.addEventListener('input', update);
  update();

  // Sécurité supplémentaire à la soumission
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', (e) => {
      const words = ta.value.trim().split(/\s+/).filter(Boolean);
      if (words.length > MAX) {
        e.preventDefault();
        alert('La description ne doit pas dépasser 200 mots.');
      }
    });
  });
})();
</script>
{% endblock %}
