{% extends "base.html" %}
{% block title %}VØtre spectacle - AnimatoSpectacle{% endblock %}
{% block content %}

<div class="demande-wrap">
  <h2>Publier votre spectacle</h2>
  <p style="color:var(--muted); margin-bottom:24px;">Remplissez le formulaire ci-dessous. Votre annonce sera examinée avant publication.</p>

  <form method="post" enctype="multipart/form-data" class="demande-form">

    <!-- SECTION: Informations de la compagnie -->
    <fieldset class="demande-section">
      <legend>Informations de la compagnie</legend>
      
      <div>
        <label>
          <span class="label-text">Raison sociale</span>
          <span class="hint">Automatique, non modifiable</span>
          <input type="text" name="raison_sociale" value="{{ user.username if user else '' }}" readonly style="background-color: #1a1a1f; cursor: not-allowed; opacity: 0.6;">
        </label>
      </div>

      <div class="grid-2">
        <div>
          <label>
            <span class="label-text">Votre e-mail</span>
            <span class="hint">Pour mettre votre adresse courriel <a href="{{ url_for('legal') }}" style="color:var(--primary);text-decoration:underline;">nous contacter</a></span>
            <input type="email" name="contact_email" value="audition_2020@yahoo.fr" readonly style="background-color: #1a1a1f; cursor: not-allowed; opacity: 0.6;">
          </label>
        </div>

        <div>
          <label>
            <span class="label-text">Votre téléphone <span class="req">*</span></span>
            <span class="hint">Visible uniquement par l'administrateur</span>
            <input type="tel" name="contact_phone" placeholder="06 12 34 56 78" required>
          </label>
        </div>
      </div>
    </fieldset>

    <!-- SECTION: Détails du spectacle -->
    <fieldset class="demande-section">
      <legend>Détails du spectacle</legend>
      
      <div>
        <label>
          <span class="label-text">Titre du spectacle <span class="req">*</span></span>
          <input type="text" name="title" placeholder="Ex: La magie des 4 éléments" required>
        </label>
      </div>

      <div>
        <label>
          <span class="label-text">Description <span class="req">*</span></span>
          <span class="hint">Maximum 200 mots - Décrivez votre spectacle, ses points forts, le message...</span>
          <textarea id="description" name="description" rows="4" placeholder="Décrivez votre spectacle..." required></textarea>
          <div id="desc-counter" style="font-size:0.85rem; color:var(--muted); margin-top:4px;">0/200 mots</div>
        </label>
      </div>

      <div class="grid-2">
        <div>
          <label>
            <span class="label-text">Région</span>
            <input type="text" name="region" placeholder="Ex: Île-de-France, Bretagne">
          </label>
        </div>

        <div>
          <label>
            <span class="label-text">Lieu</span>
            <input type="text" name="location" placeholder="Ville ou salle">
          </label>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>
            <span class="label-text">Catégorie</span>
            <input type="text" name="category" placeholder="Ex: Magie, Théâtre, Clown">
          </label>
        </div>

        <div>
          <label>
            <span class="label-text">Âge / Public</span>
            <input type="text" name="age_range" placeholder="Ex: 3-6 ans, Tout public, Adulte">
          </label>
        </div>
      </div>
    </fieldset>

    <!-- SECTION: Fichier -->
    <fieldset class="demande-section">
      <legend>Affiche ou document</legend>
      
      <div>
        <label>
          <span class="label-text">Image ou PDF</span>
          <span class="hint">Taille max : 5 MB - Formats acceptés : PNG, JPG, JPEG, GIF, WEBP, PDF</span>
          <input type="file" name="file" accept=".png,.jpg,.jpeg,.gif,.webp,.pdf">
        </label>
      </div>
    </fieldset>

    <div style="display:flex; gap:12px; justify-content:space-between; align-items:center; margin-top:24px;">
      <p style="color:var(--muted); font-size:0.9rem; margin:0;">
        <span style="color:#ffb347;">⚠️</span> Votre annonce sera visible après validation par l'administrateur
      </p>
      <div style="display:flex; gap:12px;">
        <a href="{{ url_for('home') }}" style="padding:10px 20px; border:1px solid var(--border); border-radius:8px; font-weight:600; text-decoration:none; color:var(--text);">
          Annuler
        </a>
        <button type="submit" style="background:var(--primary); color:white; padding:10px 24px; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1rem;">
          Envoyer
        </button>
      </div>
    </div>

  </form>
</div>

<!-- Limiteur 200 mots (front) -->
<script>
(function () {
  const ta = document.getElementById('description');
  const counter = document.getElementById('desc-counter');
  const MAX = 200;

  if (!ta || !counter) return;

  function update() {
    const words = ta.value.trim().split(/\s+/).filter(Boolean);
    if (words.length > MAX) {
      // tronque au-delà de 200 mots
      ta.value = words.slice(0, MAX).join(' ');
    }
    const count = ta.value.trim() ? ta.value.trim().split(/\s+/).length : 0;
    counter.textContent = `${count}/${MAX} mots`;
  }

  ta.addEventListener('input', update);
  update();

  // Sécurité supplémentaire à la soumission
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', (e) => {
      const words = ta.value.trim().split(/\s+/).filter(Boolean);
      if (words.length > MAX) {
        e.preventDefault();
        alert('La description ne doit pas dépasser 200 mots.');
      }
    });
  });
})();
</script>
{% endblock %}
