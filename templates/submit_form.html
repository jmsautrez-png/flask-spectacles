{% extends "base.html" %}
{% block title %}VØtre spectacle - AnimatoSpectacle{% endblock %}
{% block content %}

<div class="demande-wrap">
  <h2>Publier votre spectacle</h2>
  <p style="color:#fff;font-size:1.15em;font-weight:600;margin-bottom:8px;">Spectacle'ment VØtre la plateforme qui connecte facilement les organisateurs d'événements avec des artistes et compagnies de spectacle vivant.</p>

  <p style="color:var(--muted); margin-bottom:24px;">Remplissez le formulaire ci-dessous. Votre annonce sera examinée avant publication.</p>

  <form method="post" enctype="multipart/form-data" class="demande-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

    <!-- SECTION: Informations de la compagnie -->
    <fieldset class="demande-section">
      <legend>Informations de la compagnie</legend>
      
      <div>
        <label>
          <span class="label-text">Raison sociale</span>
          <span class="hint">Automatique, non modifiable</span>
          <input type="text" name="raison_sociale" value="{{ user.username if user else '' }}" readonly style="background-color: #1a1a1f; cursor: not-allowed; opacity: 0.6;">
        </label>
      </div>

      <div class="grid-2">
        <div>
          <label>
            <span class="label-text">Votre e-mail <span class="req">*</span></span>
            <span class="hint">Votre adresse e-mail de contact pour les organisateurs d'événements</span>
            <input type="email" name="contact_email" placeholder="votre@email.fr" value="{{ request.form.get('contact_email', '') }}" required>
          </label>
        </div>

        <div>
          <label>
            <span class="label-text">Votre téléphone <span class="req">*</span></span>
            <span class="hint">Visible uniquement par l'administrateur</span>
            <input type="tel" name="contact_phone" placeholder="06 12 34 56 78" required>
          </label>
        </div>
      </div>
    </fieldset>

    <!-- SECTION: Détails du spectacle -->
    <fieldset class="demande-section">
      <legend>Détails du spectacle</legend>
      <div>
        <label>
          <span class="label-text">Titre du spectacle <span class="req">*</span></span>
          <input type="text" name="title" placeholder="Ex: La magie des 4 éléments" required>
        </label>
      </div>
      <div>
        <label>
          <span class="label-text">Description <span class="req">*</span></span>
          <span class="hint">Maximum 200 mots - Décrivez votre spectacle, ses points forts, le message...</span>
          <textarea id="description" name="description" rows="4" placeholder="Décrivez votre spectacle..." required></textarea>
          <div id="desc-counter" style="font-size:0.85rem; color:var(--muted); margin-top:4px;">0/200 mots</div>
        </label>
      </div>
      <div class="grid-2">
        <div>
          <label>
            <span class="label-text">Région</span>
            <input type="text" name="region" id="region-input" placeholder="Ex: Île-de-France, Bretagne">
          </label>
          <div style="background:#e3f2fd; color:#1565c0; border:1px solid #90caf9; border-radius:7px; padding:7px 12px; margin:10px 0 8px 0; font-size:0.97em; font-weight:500;">
            Cliquez sur une région pour remplir automatiquement le champ ci-dessus&nbsp;:
          </div>
          <div class="region-buttons" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:14px; position:relative;">
            <div id="region-hover-banner" style="display:none; position:absolute; left:0; right:0; top:-38px; background:#fffde7; color:#795548; border:1px solid #ffe082; border-radius:7px; padding:7px 12px; font-size:0.97em; font-weight:500; z-index:10; text-align:center; pointer-events:none; transition:opacity 0.2s; opacity:0;">
              Cliquez pour sélectionner cette région
            </div>
            {% set regions = [
              'Auvergne-Rhône-Alpes', 'Bourgogne-Franche-Comté', 'Bretagne', 'Centre-Val de Loire', 'Corse',
              'Grand Est', 'Hauts-de-France', 'Île-de-France', 'Normandie', 'Nouvelle-Aquitaine', 'Occitanie',
              'Pays de la Loire', 'Provence-Alpes-Côte d\'Azur', 'Guadeloupe', 'Martinique', 'Guyane',
              'La Réunion', 'Mayotte'
            ] %}
            {% set region_styles = {
              'Auvergne-Rhône-Alpes':      'background:#a5d6a7; color:#1b5e20; border:1px solid #388e3c;',
              'Bourgogne-Franche-Comté':   'background:#ffe082; color:#6d4c41; border:1px solid #ffb300;',
              'Bretagne':                  'background:#90caf9; color:#0d47a1; border:1px solid #1976d2;',
              'Centre-Val de Loire':       'background:#f8bbd0; color:#ad1457; border:1px solid #ec407a;',
              'Corse':                     'background:#fff9c4; color:#795548; border:1px solid #fbc02d;',
              'Grand Est':                 'background:#b0bec5; color:#263238; border:1px solid #607d8b;',
              'Hauts-de-France':           'background:#b3e5fc; color:#01579b; border:1px solid #0288d1;',
              'Île-de-France':             'background:#d1c4e9; color:#4527a0; border:1px solid #7e57c2;',
              'Normandie':                 'background:#ffe0b2; color:#e65100; border:1px solid #ff9800;',
              'Nouvelle-Aquitaine':        'background:#c8e6c9; color:#2e7d32; border:1px solid #43a047;',
              'Occitanie':                 'background:#ffccbc; color:#bf360c; border:1px solid #ff7043;',
              'Pays de la Loire':          'background:#f0f4c3; color:#827717; border:1px solid #cddc39;',
              'Provence-Alpes-Côte d\'Azur': 'background:#ffe082; color:#e65100; border:1px solid #ffb300;',
              'Guadeloupe':                'background:#b2ebf2; color:#006064; border:1px solid #00bcd4;',
              'Martinique':                'background:#f48fb1; color:#ad1457; border:1px solid #ec407a;',
              'Guyane':                    'background:#c5e1a5; color:#33691e; border:1px solid #8bc34a;',
              'La Réunion':                'background:#ffe0b2; color:#e65100; border:1px solid #ff9800;',
              'Mayotte':                   'background:#b3e5fc; color:#01579b; border:1px solid #0288d1;'
            } %}
            {% for reg in regions %}
                <button type="button" class="btn-region"
                  style="padding:4px 10px; border-radius:5px; font-size:0.95em; cursor:pointer; margin-bottom:2px; {{ region_styles[reg]|default('background:#eee; color:#333; border:1px solid #bbb;') }}"
                  onmouseover="document.getElementById('region-hover-banner').style.display='block'; document.getElementById('region-hover-banner').style.opacity='1';"
                  onmouseout="document.getElementById('region-hover-banner').style.opacity='0'; setTimeout(function(){document.getElementById('region-hover-banner').style.display='none';},200);"
                  onclick="ajouterRegion('{{ reg }}')"
                >{{ reg }}</button>
            {% endfor %}
          </div>
        </div>
        <div>
          <label>
            <span class="label-text">Lieu</span>
            <input type="text" name="location" id="ville-input" placeholder="Ville ou salle">
          </label>
          <div style="background:#e3f2fd; color:#1565c0; border:1px solid #90caf9; border-radius:7px; padding:7px 12px; margin:10px 0 8px 0; font-size:0.97em; font-weight:500;">
            Cliquez sur une ville pour remplir automatiquement le champ ci-dessus, ou inscrivez votre ville&nbsp;:
          </div>
          <div class="ville-buttons" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:14px; position:relative;">
            <div id="ville-hover-banner" style="display:none; position:absolute; left:0; right:0; top:-38px; background:#fffde7; color:#795548; border:1px solid #ffe082; border-radius:7px; padding:7px 12px; font-size:0.97em; font-weight:500; z-index:10; text-align:center; pointer-events:none; transition:opacity 0.2s; opacity:0;">
              Cliquez pour sélectionner cette ville
            </div>
            {% set villes = [
              'Paris', 'Marseille', 'Lyon', 'Toulouse', 'Nice', 'Nantes', 'Montpellier', 'Strasbourg', 'Bordeaux',
              'Lille', 'Rennes', 'Reims', 'Le Havre', 'Saint-Étienne', 'Toulon', 'Grenoble', 'Dijon', 'Angers',
              'Nîmes', 'Villeurbanne'
            ] %}
            {% set ville_styles = {
              'Paris':         'background:#1976d2; color:#fff; border:1px solid #0d47a1;',
              'Marseille':     'background:#ffb300; color:#fff; border:1px solid #ff6f00;',
              'Lyon':          'background:#a084ca; color:#fff; border:1px solid #7c5eb6;',
              'Toulouse':      'background:#e53935; color:#fff; border:1px solid #b71c1c;',
              'Nice':          'background:#43a047; color:#fff; border:1px solid #2e7d32;',
              'Nantes':        'background:#00bcd4; color:#fff; border:1px solid #008ba3;',
              'Montpellier':   'background:#fbc02d; color:#fff; border:1px solid #f9a825;',
              'Strasbourg':    'background:#607d8b; color:#fff; border:1px solid #455a64;',
              'Bordeaux':      'background:#6d4c41; color:#fff; border:1px solid #3e2723;',
              'Lille':         'background:#ec407a; color:#fff; border:1px solid #ad1457;',
              'Rennes':        'background:#388e3c; color:#fff; border:1px solid #1b5e20;',
              'Reims':         'background:#b0bec5; color:#263238; border:1px solid #607d8b;',
              'Le Havre':      'background:#ffe082; color:#6d4c41; border:1px solid #ffb300;',
              'Saint-Étienne': 'background:#f8bbd0; color:#ad1457; border:1px solid #ec407a;',
              'Toulon':        'background:#b3e5fc; color:#01579b; border:1px solid #0288d1;',
              'Grenoble':      'background:#c8e6c9; color:#2e7d32; border:1px solid #43a047;',
              'Dijon':         'background:#ffe0b2; color:#e65100; border:1px solid #ff9800;',
              'Angers':        'background:#f0f4c3; color:#827717; border:1px solid #cddc39;',
              'Nîmes':         'background:#f48fb1; color:#ad1457; border:1px solid #ec407a;',
              'Villeurbanne':  'background:#b2ebf2; color:#006064; border:1px solid #00bcd4;'
            } %}
            {% for ville in villes %}
              <button type="button" class="btn-ville"
                style="padding:4px 10px; border-radius:5px; font-size:0.95em; cursor:pointer; margin-bottom:2px; {{ ville_styles[ville]|default('background:#eee; color:#333; border:1px solid #bbb;') }}"
                onmouseover="document.getElementById('ville-hover-banner').style.display='block'; document.getElementById('ville-hover-banner').style.opacity='1';"
                onmouseout="document.getElementById('ville-hover-banner').style.opacity='0'; setTimeout(function(){document.getElementById('ville-hover-banner').style.display='none';},200);"
                 onclick="ajouterVille('{{ ville }}')"
              >{{ ville }}</button>
            {% endfor %}
          </div>
            <script>
            function ajouterVille(ville) {
              var input = document.getElementById('ville-input');
              var villes = input.value.split(',').map(function(v) { return v.trim(); }).filter(function(v) { return v.length > 0; });
              if (villes.indexOf(ville) === -1) {
                villes.push(ville);
                input.value = villes.join(' | ');
              }
            }
            </script>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>
            <span class="label-text">Catégorie</span>
            <select name="category">
              <option value="">-- Choisir --</option>
              <optgroup label="Spectacle et Animation Artistique">
                <option value="Spectacle Maternelle">Spectacle Maternelle</option>
                <option value="Spectacle Élémentaire">Spectacle Élémentaire</option>
                <option value="Spectacle École">Spectacle École</option>
                <option value="Spectacle CSE">Spectacle CSE</option>
                <option value="Festival">Festival</option>
                <option value="Fête Foraine">Fête Foraine</option>
                <option value="Sculpteur de ballons">Sculpteur de ballons</option>
                <option value="Animation et Atelier Artistique">Animation et Atelier Artistique</option>
                <option value="Atelier divers">Atelier divers</option>
                <option value="Atelier maquillage">Atelier maquillage</option>
                <option value="Caricaturistes et Silhouettiste">Caricaturistes et Silhouettiste</option>
                <option value="Cirque">Cirque</option>
                <option value="Clown">Clown</option>
                <option value="Conte et Théâtre">Conte et Théâtre</option>
                <option value="Fête de village">Fête de village</option>
                <option value="Humoriste et Imitateur">Humoriste et Imitateur</option>
                <option value="Location de stand">Location de stand</option>
                <option value="Magie et Magicien">Magie et Magicien</option>
                <option value="Manège">Manège</option>
                <option value="Marionnettes">Marionnettes</option>
                <option value="Père Noël">Père Noël</option>
                <option value="Revue Cabaret et Danse">Revue Cabaret et Danse</option>
                <option value="Sosie">Sosie</option>
                <option value="Spectacle à Thèmes">Spectacle à Thèmes</option>
                <option value="Spectacle Animalier">Spectacle Animalier</option>
                <option value="Spectacle Arbre de Noël">Spectacle Arbre de Noël</option>
                <option value="Spectacle de danse">Spectacle de danse</option>
                <option value="Spectacle de Rue">Spectacle de Rue</option>
                <option value="Spectacle Enfants">Spectacle Enfants</option>
                <option value="Spectacle Evénementiel">Spectacle Evénementiel</option>
                <option value="Spectacle Musical">Spectacle Musical</option>
                <option value="Ventriloque">Ventriloque</option>
              </optgroup>
              <optgroup label="Groupe de Musique et Musicien">
                <option value="Accordéoniste">Accordéoniste</option>
                <option value="Animation Musicale">Animation Musicale</option>
                <option value="Chorale et Gospel">Chorale et Gospel</option>
                <option value="D.J. et Orchestre">D.J. et Orchestre</option>
                <option value="Fanfare et Batucada">Fanfare et Batucada</option>
                <option value="Groupe folklorique">Groupe folklorique</option>
                <option value="Jazz">Jazz</option>
                <option value="Musique Classique">Musique Classique</option>
                <option value="Orgue de Barbarie">Orgue de Barbarie</option>
                <option value="Pianiste">Pianiste</option>
                <option value="Rock et Country">Rock et Country</option>
              </optgroup>
              <option value="Autre">Autre (précisez ci-dessous)</option>
            </select>
          </label>
          <label id="autre_category_container" style="display:none; margin-top:10px;">
            <span class="label-text">Précisez votre catégorie</span>
            <input type="text" id="autre_category" name="autre_category" placeholder="Décrivez votre type de spectacle">
          </label>
          <div style="display:none; background:#e3f2fd; color:#1565c0; border:1px solid #90caf9; border-radius:7px; padding:7px 12px; margin:10px 0 8px 0; font-size:0.97em; font-weight:500;">
            Cliquez sur une catégorie pour remplir automatiquement le champ ci-dessus&nbsp;:
          </div>
          <div class="category-buttons" style="display:none; flex-wrap:wrap; gap:6px; margin-bottom:14px; position:relative;">
            <div id="category-hover-banner" style="display:none; position:absolute; left:0; right:0; top:-38px; background:#fffde7; color:#795548; border:1px solid #ffe082; border-radius:7px; padding:7px 12px; font-size:0.97em; font-weight:500; z-index:10; text-align:center; pointer-events:none; transition:opacity 0.2s; opacity:0;">
              Cliquez pour sélectionner cette catégorie
            </div>
            <script>
            function ajouterCategorie(cat) {
                var input = document.getElementById('category-input');
                var cats = input.value.split(',').map(function(c) { return c.trim(); }).filter(function(c) { return c.length > 0; });
                if (cats.indexOf(cat) === -1) {
                    cats.push(cat);
                    input.value = cats.join(' | ');
                }
            }
            </script>
            {% set categories = [
              'Marionnette', 'Magie', 'Clown', 'Théâtre', 'Spectacle enfant', 'Atelier', 'Concert', 'Cirque',
              'Spectacle de rue', 'Orchestre', 'Arbre de Noël', 'Animation école', 'Fête de village', 'Danse'
            ] %}
            {% set cat_styles = {
              'Marionnette':   'background:#a084ca; color:#fff; border:1px solid #7c5eb6;',
              'Magie':         'background:#1976d2; color:#fff; border:1px solid #1565c0;',
              'Clown':         'background:#ff9800; color:#fff; border:1px solid #f57c00;',
              'Théâtre':       'background:#8d6e63; color:#fff; border:1px solid #6d4c41;',
              'Spectacle enfant': 'background:#43a047; color:#fff; border:1px solid #2e7d32;',
              'Atelier':       'background:#00bcd4; color:#fff; border:1px solid #008ba3;',
              'Concert':       'background:#e53935; color:#fff; border:1px solid #b71c1c;',
              'Cirque':        'background:#fbc02d; color:#fff; border:1px solid #f9a825;',
              'Spectacle de rue': 'background:#607d8b; color:#fff; border:1px solid #455a64;',
              'Orchestre':     'background:#6d4c41; color:#fff; border:1px solid #3e2723;',
              'Arbre de Noël': 'background:#388e3c; color:#fff; border:1px solid #1b5e20;',
              'Animation école': 'background:#ec407a; color:#fff; border:1px solid #ad1457;',
              'Fête de village': 'background:#ffb300; color:#fff; border:1px solid #ff6f00;',
              'Danse': 'background:#ab47bc; color:#fff; border:1px solid #7c43bd;'
            } %}
            {% for cat in categories %}
              <button type="button" class="btn-category"
                style="padding:4px 10px; border-radius:5px; font-size:0.95em; cursor:pointer; margin-bottom:2px; {{ cat_styles[cat] }}"
                onmouseover="document.getElementById('category-hover-banner').style.display='block'; document.getElementById('category-hover-banner').style.opacity='1';"
                onmouseout="document.getElementById('category-hover-banner').style.opacity='0'; setTimeout(function(){document.getElementById('category-hover-banner').style.display='none';},200);"
                onclick="ajouterCategorie('{{ cat }}')"
              >{{ cat }}</button>
            {% endfor %}
          </div>
        </div>
        <div>
          <label>
            <span class="label-text">Âge / Public</span>
            <select name="age_range" required>
              <option value="">-- Choisir --</option>
              <option value="enfant">Enfant</option>
              <option value="enfant_2_6">Enfant (2/6 ans)</option>
              <option value="enfant_6_10">Enfant (6/10 ans)</option>
              <option value="enfant_2_10">Enfant (2/10 ans)</option>
              <option value="adolescent">Adolescent</option>
              <option value="adulte">Adulte</option>
              <option value="tout public">Tout public</option>
            </select>
          </label>
        </div>
      </div>
    </fieldset>

    <!-- SECTION: Fichier -->
    <fieldset class="demande-section">
      <legend>Affiche ou document</legend>
      
      <div>
        <label>
          <span class="label-text">Image ou PDF</span>
          <span class="hint">Taille max : 5 MB - Formats acceptés : PNG, JPG, JPEG, GIF, WEBP, PDF</span>
          <input type="file" name="file" accept=".png,.jpg,.jpeg,.gif,.webp,.pdf">
        </label>
      </div>
    </fieldset>

    <div style="display:flex; gap:12px; justify-content:space-between; align-items:center; margin-top:24px;">
      <p style="color:var(--muted); font-size:0.9rem; margin:0;">
        <span style="color:#ffb347;">⚠️</span> Votre annonce sera visible après validation par l'administrateur
      </p>
      <div style="display:flex; gap:12px;">
        <a href="{{ url_for('home') }}" style="padding:10px 20px; border:1px solid var(--border); border-radius:8px; font-weight:600; text-decoration:none; color:var(--text);">
          Annuler
        </a>
        <button type="submit" style="background:var(--primary); color:white; padding:10px 24px; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1rem;">
          Envoyer
        </button>
      </div>
    </div>

  </form>
</div>

              <script>
              function ajouterRegion(region) {
                  var input = document.getElementById('region-input');
                  var regions = input.value.split(',').map(function(r) { return r.trim(); }).filter(function(r) { return r.length > 0; });
                  if (regions.indexOf(region) === -1) {
                      regions.push(region);
                      input.value = regions.join(' | ');
                  }
              }
              </script>
<!-- Limiteur 200 mots (front) -->
<script>
(function () {
  const ta = document.getElementById('description');
  const counter = document.getElementById('desc-counter');
  const MAX = 200;

  if (!ta || !counter) return;

  function update() {
    const words = ta.value.trim().split(/\s+/).filter(Boolean);
    if (words.length > MAX) {
      // tronque au-delà de 200 mots
      ta.value = words.slice(0, MAX).join(' ');
    }
    const count = ta.value.trim() ? ta.value.trim().split(/\s+/).length : 0;
    counter.textContent = `${count}/${MAX} mots`;
  }

  ta.addEventListener('input', update);
  update();

  // Gestion de l'affichage du champ "Autre catégorie"
  var categorySelect = document.querySelector('select[name="category"]');
  var autreContainer = document.getElementById('autre_category_container');
  var autreInput = document.getElementById('autre_category');
  
  if (categorySelect && autreContainer) {
    categorySelect.addEventListener('change', function() {
      if (this.value === 'Autre') {
        autreContainer.style.display = 'block';
      } else {
        autreContainer.style.display = 'none';
        if (autreInput) autreInput.value = '';
      }
    });
  }

  // Sécurité supplémentaire à la soumission
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', (e) => {
      const words = ta.value.trim().split(/\s+/).filter(Boolean);
      if (words.length > MAX) {
        e.preventDefault();
        alert('La description ne doit pas dépasser 200 mots.');
      }
    });
  });
})();
</script>
{% endblock %}
