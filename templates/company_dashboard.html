{% extends "base.html" %}
{% block title %}Mes spectacles - AnimatoSpectacle{% endblock %}
{% block content %}
<h1>Mes spectacles</h1>

<p>
    <a class="btn publish-btn" href="{{ url_for('publish') }}">
        + Publier un spectacle
    </a>
</p>

<div class="cards">
{% for s in shows %} 

  <article class="card">
    <div class="media">
      {% set images = s.get_all_images() %}
      {% if images|length > 1 %}
        <div class="card-carousel" data-carousel>
          <div class="carousel-slides">
            {% for img in images %}
            <div class="carousel-slide">
              <img src="{{ url_for('uploaded_file', filename=img) }}" alt="{{ s.title }}{% if loop.index > 1 %} - Photo {{ loop.index }}{% endif %}">
            </div>
            {% endfor %}
          </div>
          <div class="carousel-indicators">
            {% for img in images %}
            <span class="carousel-indicator{% if loop.first %} active{% endif %}" data-slide="{{ loop.index0 }}"></span>
            {% endfor %}
          </div>
          <button class="carousel-nav carousel-prev" aria-label="Photo précédente">‹</button>
          <button class="carousel-nav carousel-next" aria-label="Photo suivante">›</button>
        </div>
      {% elif s.has_image() %}
        <a href="{{ url_for('show_detail', show_id=s.id) }}">
          <img src="{{ url_for('uploaded_file', filename=s.file_name) }}" alt="{{ s.title }}" style="cursor:pointer;">
        </a>
      {% elif s.is_pdf() %}
        <div class="pdf-thumb">
          <a href="{{ url_for('uploaded_file', filename=s.file_name) }}" target="_blank" rel="noopener">PDF</a>
        </div>
      {% else %}
        <div class="placeholder">Aucun fichier</div>
      {% endif %}
    </div>

    <div class="content">
      {% if s.raison_sociale %}<p class="meta" style="font-weight:600; margin-bottom:8px; color:var(--primary);">{{ s.raison_sociale }}</p>{% endif %}
      <h3>{{ s.title }}</h3>
      {% if not s.approved %}
        <p class="meta" style="color:#ffb347;">(En attente de validation)</p>
      {% endif %}
    </div>

    <div class="actions">
      <a href="{{ url_for('show_edit_self', show_id=s.id) }}">Modifier</a>
      
      <form action="{{ url_for('show_delete_self', show_id=s.id) }}" method="post" style="margin:0;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <button type="submit" class="danger" onclick="return confirm('Supprimer ce spectacle ?')">
          Supprimer
        </button>
      </form>
    </div>
  </article>

{% else %}
  <p>Vous n'avez pas encore de spectacle publié.</p>
{% endfor %}
</div>

<script>
(function() {
  document.querySelectorAll('[data-carousel]').forEach(function(carousel) {
    const slides = carousel.querySelector('.carousel-slides');
    const indicators = carousel.querySelectorAll('.carousel-indicator');
    const prevBtn = carousel.querySelector('.carousel-prev');
    const nextBtn = carousel.querySelector('.carousel-next');
    const totalSlides = carousel.querySelectorAll('.carousel-slide').length;
    let currentSlide = 0;
    let autoPlayInterval = null;

    function goToSlide(index) {
      if (index < 0) index = totalSlides - 1;
      if (index >= totalSlides) index = 0;
      currentSlide = index;
      slides.style.transform = 'translateX(-' + (currentSlide * 100) + '%)';
      indicators.forEach(function(ind, i) {
        ind.classList.toggle('active', i === currentSlide);
      });
    }

    function nextSlide() { goToSlide(currentSlide + 1); }
    function prevSlide() { goToSlide(currentSlide - 1); }
    function startAutoPlay() {
      if (autoPlayInterval) clearInterval(autoPlayInterval);
      autoPlayInterval = setInterval(nextSlide, 8000);
    }
    function stopAutoPlay() {
      if (autoPlayInterval) { clearInterval(autoPlayInterval); autoPlayInterval = null; }
    }

    if (prevBtn) prevBtn.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); prevSlide(); startAutoPlay(); });
    if (nextBtn) nextBtn.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); nextSlide(); startAutoPlay(); });
    indicators.forEach(function(indicator, i) {
      indicator.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); goToSlide(i); startAutoPlay(); });
    });
    startAutoPlay();
    carousel.addEventListener('mouseenter', stopAutoPlay);
    carousel.addEventListener('mouseleave', startAutoPlay);
  });
})();
</script>
{% endblock %}
