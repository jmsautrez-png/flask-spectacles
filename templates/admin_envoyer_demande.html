{% extends "base.html" %}

{% block title %}Envoyer la demande d'animation{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">üìß Envoyer la demande d'animation aux utilisateurs</h3>
                </div>
                <div class="card-body">
                    <!-- D√©tails de la demande -->
                    <div class="alert alert-info">
                        <h5>üìã Demande √† envoyer :</h5>
                        <ul class="mb-0">
                            <li><strong>Structure :</strong> {{ demande.structure }}</li>
                            <li><strong>Lieu :</strong> {{ demande.lieu_ville }}</li>
                            <li><strong>Type recherch√© :</strong> {{ demande.genre_recherche }}</li>
                            <li><strong>Date(s) :</strong> {{ demande.dates_horaires }}</li>
                            <li><strong>Budget :</strong> {{ demande.budget }}</li>
                            <li><strong>Jauge :</strong> {{ demande.jauge }}</li>
                        </ul>
                    </div>

                    <form method="post" class="mt-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <h5 class="mb-3">üéØ S√©lectionner les cat√©gories de spectacles :</h5>
                        <p class="text-muted">Cochez les cat√©gories pour envoyer cette demande aux utilisateurs concern√©s.</p>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <strong>üìÇ Cat√©gories</strong>
                                        <button type="button" class="btn btn-sm btn-outline-primary float-end" onclick="selectAllCategories()">
                                            Tout s√©lectionner
                                        </button>
                                    </div>
                                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                        {% if categories %}
                                            {% for category in categories %}
                                            <div class="form-check mb-2">
                                                <input class="form-check-input category-checkbox" type="checkbox" 
                                                       name="categories" value="{{ category }}" id="cat_{{ loop.index }}">
                                                <label class="form-check-label" for="cat_{{ loop.index }}">
                                                    {{ category }}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">Aucune cat√©gorie disponible</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <strong>‚ö†Ô∏è Attention :</strong> Les emails seront envoy√©s imm√©diatement apr√®s validation.
                            V√©rifiez bien votre s√©lection avant de continuer.
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                                ‚Üê Retour
                            </a>
                            <button type="submit" class="btn btn-success btn-lg" id="btn-envoyer">
                                üìß Envoyer maintenant
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    console.log('‚úÖ Script charg√©');
    
    // Fonction pour s√©lectionner/d√©s√©lectionner toutes les cat√©gories
    function selectAllCategories() {
        console.log('Toggle toutes les cat√©gories');
        const checkboxes = document.querySelectorAll('.category-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }
    
    // Validation avant soumission
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM charg√©');
        
        const form = document.querySelector('form');
        if (!form) {
            console.error('‚ùå Formulaire non trouv√©');
            return;
        }
        
        console.log('‚úÖ Formulaire trouv√©, ajout du listener');
        
        form.addEventListener('submit', function(e) {
            console.log('üì§ √âv√©nement submit d√©clench√©');
            
            const checkboxes = document.querySelectorAll('.category-checkbox:checked');
            console.log(`üìä ${checkboxes.length} cat√©gorie(s) s√©lectionn√©e(s)`);
            
            if (checkboxes.length === 0) {
                e.preventDefault();
                alert('‚ö†Ô∏è Veuillez s√©lectionner au moins une cat√©gorie');
                console.log('‚ùå Soumission annul√©e: aucune cat√©gorie');
                return false;
            }
            
            const confirmed = confirm(`Envoyer cette demande √† ${checkboxes.length} cat√©gorie(s) ?\n\n‚úâÔ∏è Les emails seront envoy√©s aux adresses r√©elles des utilisateurs.`);
            console.log('Confirmation:', confirmed ? '‚úÖ OUI' : '‚ùå NON');
            
            if (!confirmed) {
                e.preventDefault();
                console.log('‚ùå Soumission annul√©e par utilisateur');
                return false;
            }
            
            console.log('‚úÖ Soumission du formulaire en cours...');
            return true;
        });
    });
</script>
{% endblock %}
