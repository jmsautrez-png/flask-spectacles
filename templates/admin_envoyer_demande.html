{% extends "base.html" %}

{% block title %}Envoyer la demande d'animation{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">üìß Envoyer la demande d'animation aux utilisateurs</h3>
                </div>
                <div class="card-body">
                    <!-- D√©tails de la demande -->
                    <div class="alert alert-info">
                        <h5>üìã Demande √† envoyer :</h5>
                        <ul class="mb-0">
                            <li><strong>Structure :</strong> {{ demande.structure }}</li>
                            <li><strong>Lieu :</strong> {{ demande.lieu_ville }} 
                                <span id="region-detectee" class="badge bg-success ms-2" style="display:none;"></span>
                            </li>
                            <li><strong>Type recherch√© :</strong> {{ demande.genre_recherche }}</li>
                            <li><strong>Date(s) :</strong> {{ demande.dates_horaires }}</li>
                            <li><strong>Budget :</strong> {{ demande.budget }}</li>
                            <li><strong>Jauge :</strong> {{ demande.jauge }}</li>
                        </ul>
                    </div>

                    <form method="post" class="mt-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <h5 class="mb-3">üéØ S√©lectionner les cat√©gories de spectacles :</h5>
                        <p class="text-muted">Cochez les cat√©gories pour envoyer cette demande aux utilisateurs concern√©s.</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <strong>üìÇ Cat√©gories</strong>
                                        <button type="button" class="btn btn-sm btn-outline-primary float-end" onclick="selectAllCategories()">
                                            Tout s√©lectionner
                                        </button>
                                    </div>
                                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                        {% if categories %}
                                            {% for category in categories %}
                                            <div class="form-check mb-2">
                                                <input class="form-check-input category-checkbox" type="checkbox" 
                                                       name="categories" value="{{ category }}" id="cat_{{ loop.index }}">
                                                <label class="form-check-label" for="cat_{{ loop.index }}">
                                                    {{ category }}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">Aucune cat√©gorie disponible</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <strong>üó∫Ô∏è R√©gions</strong>
                                        <button type="button" class="btn btn-sm btn-outline-success float-end" onclick="selectAllRegions()">
                                            Tout s√©lectionner
                                        </button>
                                    </div>
                                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                        <p class="text-muted mb-2"><small>‚ö° Laissez vide pour envoyer √† toutes les r√©gions</small></p>
                                        {% set regions = [
                                            'Auvergne-Rh√¥ne-Alpes', 'Bourgogne-Franche-Comt√©', 'Bretagne', 'Centre-Val de Loire',
                                            'Corse', 'Grand Est', 'Hauts-de-France', '√éle-de-France', 'Normandie',
                                            'Nouvelle-Aquitaine', 'Occitanie', 'Pays de la Loire', "Provence-Alpes-C√¥te d'Azur",
                                            'Guadeloupe', 'Martinique', 'Guyane', 'La R√©union', 'Mayotte', 'France enti√®re'
                                        ] %}
                                        {% for region in regions %}
                                        <div class="form-check mb-2">
                                            <input class="form-check-input region-checkbox" type="checkbox" 
                                                   name="regions" value="{{ region }}" id="reg_{{ loop.index }}">
                                            <label class="form-check-label" for="reg_{{ loop.index }}">
                                                {{ region }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <strong>‚ö†Ô∏è Attention :</strong> Les emails seront envoy√©s imm√©diatement apr√®s validation.
                            V√©rifiez bien votre s√©lection avant de continuer.
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                                ‚Üê Retour
                            </a>
                            <button type="submit" class="btn btn-success btn-lg" id="btn-envoyer">
                                üìß Envoyer maintenant
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    console.log('‚úÖ Script charg√©');
    
    // Fonction pour s√©lectionner/d√©s√©lectionner toutes les cat√©gories
    function selectAllCategories() {
        console.log('Toggle toutes les cat√©gories');
        const checkboxes = document.querySelectorAll('.category-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }
    
    // Fonction pour s√©lectionner/d√©s√©lectionner toutes les r√©gions
    function selectAllRegions() {
        console.log('Toggle toutes les r√©gions');
        const checkboxes = document.querySelectorAll('.region-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }
    
    // Validation avant soumission
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ DOM charg√©');
        
        const form = document.querySelector('form');
        if (!form) {
            console.error('‚ùå Formulaire non trouv√©');
            return;
        }
        
        console.log('‚úÖ Formulaire trouv√©, ajout du listener');
        
        form.addEventListener('submit', function(e) {
            console.log('üì§ √âv√©nement submit d√©clench√©');
            
            const catCheckboxes = document.querySelectorAll('.category-checkbox:checked');
            const regCheckboxes = document.querySelectorAll('.region-checkbox:checked');
            console.log(`üìä ${catCheckboxes.length} cat√©gorie(s) et ${regCheckboxes.length} r√©gion(s) s√©lectionn√©e(s)`);
            
            if (catCheckboxes.length === 0) {
                e.preventDefault();
                alert('‚ö†Ô∏è Veuillez s√©lectionner au moins une cat√©gorie');
                console.log('‚ùå Soumission annul√©e: aucune cat√©gorie');
                return false;
            }
            
            let confirmMsg = `Envoyer cette demande √† ${catCheckboxes.length} cat√©gorie(s)`;
            if (regCheckboxes.length > 0) {
                confirmMsg += ` et ${regCheckboxes.length} r√©gion(s)`;
            } else {
                confirmMsg += ` (toutes r√©gions)`;
            }
            confirmMsg += ` ?\n\n‚úâÔ∏è Les emails seront envoy√©s aux adresses r√©elles des utilisateurs.`;
            
            const confirmed = confirm(confirmMsg);
            console.log('Confirmation:', confirmed ? '‚úÖ OUI' : '‚ùå NON');
            
            if (!confirmed) {
                e.preventDefault();
                console.log('‚ùå Soumission annul√©e par utilisateur');
                return false;
            }
            
            console.log('‚úÖ Soumission du formulaire en cours...');
            return true;
        });
        
        // D√©tection automatique de la r√©gion √† partir du lieu
        detecterRegion();
    });
    
    // Mapping des villes fran√ßaises vers leurs r√©gions
    const villeVersRegion = {
        // √éle-de-France
        'paris': '√éle-de-France', 'boulogne-billancourt': '√éle-de-France', 'saint-denis': '√éle-de-France',
        'argenteuil': '√éle-de-France', 'montreuil': '√éle-de-France', 'nanterre': '√éle-de-France',
        'cr√©teil': '√éle-de-France', 'versailles': '√éle-de-France', 'vitry-sur-seine': '√éle-de-France',
        'colombes': '√éle-de-France', 'asni√®res-sur-seine': '√éle-de-France', 'courbevoie': '√éle-de-France',
        'aulnay-sous-bois': '√éle-de-France', 'rueil-malmaison': '√éle-de-France', 'champigny-sur-marne': '√éle-de-France',
        'aubervilliers': '√éle-de-France', 'drancy': '√éle-de-France', 'noisy-le-grand': '√éle-de-France',
        'levallois-perret': '√éle-de-France', 'issy-les-moulineaux': '√éle-de-France', 'cergy': '√éle-de-France',
        'evry': '√éle-de-France', 'meaux': '√éle-de-France', 'melun': '√éle-de-France', 'pontoise': '√éle-de-France',
        'mantes-la-jolie': '√éle-de-France', 'sartrouville': '√éle-de-France', 'maisons-alfort': '√éle-de-France',
        
        // Auvergne-Rh√¥ne-Alpes
        'lyon': 'Auvergne-Rh√¥ne-Alpes', 'villeurbanne': 'Auvergne-Rh√¥ne-Alpes', 'saint-etienne': 'Auvergne-Rh√¥ne-Alpes',
        'grenoble': 'Auvergne-Rh√¥ne-Alpes', 'clermont-ferrand': 'Auvergne-Rh√¥ne-Alpes', 'annecy': 'Auvergne-Rh√¥ne-Alpes',
        'valence': 'Auvergne-Rh√¥ne-Alpes', 'chambery': 'Auvergne-Rh√¥ne-Alpes', 'bourg-en-bresse': 'Auvergne-Rh√¥ne-Alpes',
        'roanne': 'Auvergne-Rh√¥ne-Alpes', 'vienne': 'Auvergne-Rh√¥ne-Alpes', 'annemasse': 'Auvergne-Rh√¥ne-Alpes',
        'thonon-les-bains': 'Auvergne-Rh√¥ne-Alpes', 'aurillac': 'Auvergne-Rh√¥ne-Alpes', 'le puy-en-velay': 'Auvergne-Rh√¥ne-Alpes',
        'montelimar': 'Auvergne-Rh√¥ne-Alpes', 'oyonnax': 'Auvergne-Rh√¥ne-Alpes', 'albertville': 'Auvergne-Rh√¥ne-Alpes',
        
        // Provence-Alpes-C√¥te d'Azur
        'marseille': "Provence-Alpes-C√¥te d'Azur", 'nice': "Provence-Alpes-C√¥te d'Azur", 'toulon': "Provence-Alpes-C√¥te d'Azur",
        'aix-en-provence': "Provence-Alpes-C√¥te d'Azur", 'avignon': "Provence-Alpes-C√¥te d'Azur", 'antibes': "Provence-Alpes-C√¥te d'Azur",
        'cannes': "Provence-Alpes-C√¥te d'Azur", 'la seyne-sur-mer': "Provence-Alpes-C√¥te d'Azur", 'hyeres': "Provence-Alpes-C√¥te d'Azur",
        'frejus': "Provence-Alpes-C√¥te d'Azur", 'arles': "Provence-Alpes-C√¥te d'Azur", 'grasse': "Provence-Alpes-C√¥te d'Azur",
        'martigues': "Provence-Alpes-C√¥te d'Azur", 'aubagne': "Provence-Alpes-C√¥te d'Azur", 'gap': "Provence-Alpes-C√¥te d'Azur",
        'digne-les-bains': "Provence-Alpes-C√¥te d'Azur", 'menton': "Provence-Alpes-C√¥te d'Azur", 'salon-de-provence': "Provence-Alpes-C√¥te d'Azur",
        
        // Nouvelle-Aquitaine
        'bordeaux': 'Nouvelle-Aquitaine', 'limoges': 'Nouvelle-Aquitaine', 'poitiers': 'Nouvelle-Aquitaine',
        'merignac': 'Nouvelle-Aquitaine', 'pessac': 'Nouvelle-Aquitaine', 'pau': 'Nouvelle-Aquitaine',
        'la rochelle': 'Nouvelle-Aquitaine', 'angouleme': 'Nouvelle-Aquitaine', 'bayonne': 'Nouvelle-Aquitaine',
        'brive-la-gaillarde': 'Nouvelle-Aquitaine', 'niort': 'Nouvelle-Aquitaine', 'perigueux': 'Nouvelle-Aquitaine',
        'agen': 'Nouvelle-Aquitaine', 'mont-de-marsan': 'Nouvelle-Aquitaine', 'biarritz': 'Nouvelle-Aquitaine',
        'arcachon': 'Nouvelle-Aquitaine', 'dax': 'Nouvelle-Aquitaine', 'cognac': 'Nouvelle-Aquitaine',
        
        // Occitanie
        'toulouse': 'Occitanie', 'montpellier': 'Occitanie', 'nimes': 'Occitanie', 'perpignan': 'Occitanie',
        'beziers': 'Occitanie', 'narbonne': 'Occitanie', 'carcassonne': 'Occitanie', 'albi': 'Occitanie',
        'tarbes': 'Occitanie', 'castres': 'Occitanie', 'sete': 'Occitanie', 'montauban': 'Occitanie',
        'ales': 'Occitanie', 'rodez': 'Occitanie', 'cahors': 'Occitanie', 'auch': 'Occitanie',
        'mende': 'Occitanie', 'foix': 'Occitanie', 'lourdes': 'Occitanie', 'millau': 'Occitanie',
        
        // Grand Est
        'strasbourg': 'Grand Est', 'reims': 'Grand Est', 'metz': 'Grand Est', 'mulhouse': 'Grand Est',
        'nancy': 'Grand Est', 'colmar': 'Grand Est', 'troyes': 'Grand Est', 'charleville-mezieres': 'Grand Est',
        'chalons-en-champagne': 'Grand Est', 'epinal': 'Grand Est', 'thionville': 'Grand Est', 'haguenau': 'Grand Est',
        'saint-dizier': 'Grand Est', 'bar-le-duc': 'Grand Est', 'verdun': 'Grand Est', 'sedan': 'Grand Est',
        
        // Hauts-de-France
        'lille': 'Hauts-de-France', 'amiens': 'Hauts-de-France', 'roubaix': 'Hauts-de-France',
        'dunkerque': 'Hauts-de-France', 'tourcoing': 'Hauts-de-France', 'calais': 'Hauts-de-France',
        'douai': 'Hauts-de-France', 'lens': 'Hauts-de-France', 'valenciennes': 'Hauts-de-France',
        'beauvais': 'Hauts-de-France', 'arras': 'Hauts-de-France', 'saint-quentin': 'Hauts-de-France',
        'compiegne': 'Hauts-de-France', 'boulogne-sur-mer': 'Hauts-de-France', 'laon': 'Hauts-de-France',
        'soissons': 'Hauts-de-France', 'cambrai': 'Hauts-de-France', 'bethune': 'Hauts-de-France',
        
        // Pays de la Loire
        'nantes': 'Pays de la Loire', 'angers': 'Pays de la Loire', 'le mans': 'Pays de la Loire',
        'saint-nazaire': 'Pays de la Loire', 'la roche-sur-yon': 'Pays de la Loire', 'cholet': 'Pays de la Loire',
        'laval': 'Pays de la Loire', 'saumur': 'Pays de la Loire', 'les sables-d\'olonne': 'Pays de la Loire',
        
        // Bretagne
        'rennes': 'Bretagne', 'brest': 'Bretagne', 'quimper': 'Bretagne', 'lorient': 'Bretagne',
        'vannes': 'Bretagne', 'saint-brieuc': 'Bretagne', 'saint-malo': 'Bretagne', 'lanester': 'Bretagne',
        'fougeres': 'Bretagne', 'concarneau': 'Bretagne', 'morlaix': 'Bretagne', 'lannion': 'Bretagne',
        
        // Normandie
        'le havre': 'Normandie', 'rouen': 'Normandie', 'caen': 'Normandie', 'cherbourg': 'Normandie',
        'evreux': 'Normandie', 'dieppe': 'Normandie', 'alencon': 'Normandie', 'lisieux': 'Normandie',
        'saint-lo': 'Normandie', 'argentan': 'Normandie', 'granville': 'Normandie', 'honfleur': 'Normandie',
        'deauville': 'Normandie', 'fecamp': 'Normandie', 'vernon': 'Normandie',
        
        // Centre-Val de Loire
        'tours': 'Centre-Val de Loire', 'orleans': 'Centre-Val de Loire', 'bourges': 'Centre-Val de Loire',
        'blois': 'Centre-Val de Loire', 'chartres': 'Centre-Val de Loire', 'chateauroux': 'Centre-Val de Loire',
        'joue-les-tours': 'Centre-Val de Loire', 'dreux': 'Centre-Val de Loire', 'vierzon': 'Centre-Val de Loire',
        'montargis': 'Centre-Val de Loire', 'amboise': 'Centre-Val de Loire', 'chinon': 'Centre-Val de Loire',
        
        // Bourgogne-Franche-Comt√©
        'dijon': 'Bourgogne-Franche-Comt√©', 'besancon': 'Bourgogne-Franche-Comt√©', 'belfort': 'Bourgogne-Franche-Comt√©',
        'chalon-sur-saone': 'Bourgogne-Franche-Comt√©', 'auxerre': 'Bourgogne-Franche-Comt√©', 'nevers': 'Bourgogne-Franche-Comt√©',
        'macon': 'Bourgogne-Franche-Comt√©', 'montbeliard': 'Bourgogne-Franche-Comt√©', 'sens': 'Bourgogne-Franche-Comt√©',
        'le creusot': 'Bourgogne-Franche-Comt√©', 'dole': 'Bourgogne-Franche-Comt√©', 'lons-le-saunier': 'Bourgogne-Franche-Comt√©',
        'vesoul': 'Bourgogne-Franche-Comt√©', 'beaune': 'Bourgogne-Franche-Comt√©',
        
        // Corse
        'ajaccio': 'Corse', 'bastia': 'Corse', 'porto-vecchio': 'Corse', 'corte': 'Corse',
        'calvi': 'Corse', 'bonifacio': 'Corse', 'propriano': 'Corse',
        
        // DOM-TOM
        'fort-de-france': 'Martinique', 'le lamentin': 'Martinique', 'pointe-a-pitre': 'Guadeloupe',
        'les abymes': 'Guadeloupe', 'cayenne': 'Guyane', 'saint-denis': 'La R√©union',
        'saint-pierre': 'La R√©union', 'le port': 'La R√©union', 'mamoudzou': 'Mayotte'
    };
    
    function normaliserTexte(texte) {
        return texte.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z\s-]/g, '')
            .trim();
    }
    
    function detecterRegion() {
        const lieu = "{{ demande.lieu_ville }}";
        const lieuNormalise = normaliserTexte(lieu);
        const badge = document.getElementById('region-detectee');
        
        // Chercher une correspondance directe
        if (villeVersRegion[lieuNormalise]) {
            badge.textContent = 'üó∫Ô∏è R√©gion sugg√©r√©e : ' + villeVersRegion[lieuNormalise];
            badge.style.display = 'inline';
            // Pr√©-cocher la r√©gion correspondante
            precocherRegion(villeVersRegion[lieuNormalise]);
            return;
        }
        
        // Chercher une correspondance partielle
        for (const [ville, region] of Object.entries(villeVersRegion)) {
            if (lieuNormalise.includes(ville) || ville.includes(lieuNormalise)) {
                badge.textContent = 'üó∫Ô∏è R√©gion sugg√©r√©e : ' + region;
                badge.style.display = 'inline';
                precocherRegion(region);
                return;
            }
        }
        
        // V√©rifier si le lieu contient directement un nom de r√©gion
        const regions = ['ile-de-france', 'auvergne-rhone-alpes', 'provence-alpes-cote d\'azur', 
            'nouvelle-aquitaine', 'occitanie', 'grand est', 'hauts-de-france', 'pays de la loire',
            'bretagne', 'normandie', 'centre-val de loire', 'bourgogne-franche-comte', 'corse',
            'guadeloupe', 'martinique', 'guyane', 'la reunion', 'mayotte'];
        
        for (const reg of regions) {
            if (lieuNormalise.includes(reg)) {
                badge.textContent = 'üó∫Ô∏è R√©gion d√©tect√©e : ' + reg.charAt(0).toUpperCase() + reg.slice(1);
                badge.style.display = 'inline';
                return;
            }
        }
        
        badge.textContent = '‚ö†Ô∏è R√©gion non d√©tect√©e automatiquement';
        badge.className = 'badge bg-warning text-dark ms-2';
        badge.style.display = 'inline';
    }
    
    function precocherRegion(regionName) {
        // Chercher la checkbox correspondant √† cette r√©gion et la pr√©-cocher
        const checkboxes = document.querySelectorAll('.region-checkbox');
        checkboxes.forEach(cb => {
            if (cb.value.toLowerCase().includes(regionName.toLowerCase()) || 
                regionName.toLowerCase().includes(cb.value.toLowerCase())) {
                cb.checked = true;
                cb.parentElement.style.background = '#d4edda';
                cb.parentElement.style.borderRadius = '4px';
                cb.parentElement.style.padding = '2px 6px';
            }
        });
    }
</script>
{% endblock %}
